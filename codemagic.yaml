workflows:
  beytei-ios-release:
    name: Build & Publish Beytei iOS
    max_build_duration: 60
    instance_type: mac_mini_m2
    environment:
      vars:
        APP_STORE_CONNECT_ISSUER_ID: "84eb9662-6707-4afc-9a02-c1d1d2d9d824" # âœ… Ø¹Ø¯Ù‘Ù„ Ù‡Ø°Ù‡ Ø¥Ù† Ù„Ø²Ù…
        APP_STORE_CONNECT_KEY_IDENTIFIER: "668NQ5UL7K"
        APP_STORE_CONNECT_PRIVATE_KEY: Encrypted(************) # Ø£Ø¶Ù Ù…ÙØªØ§Ø­Ùƒ Ù‡Ù†Ø§ Ù…Ù† Codemagic variables
        BUNDLE_ID: "co.median.ios.wqwnby"
        APPLE_APP_ID: "1234567890" # Ø¶Ø¹ Ø±Ù‚Ù… App ID Ø§Ù„Ø®Ø§Øµ Ø¨ØªØ·Ø¨ÙŠÙ‚Ùƒ Ù…Ù† App Store Connect
      flutter: stable
      xcode: latest
      cocoapods: default
      groups:
        - appstore_credentials
        - ios_credentials

    scripts:
      # ğŸ§¹ 1. ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ÙˆØ§Ù„Ø¨ÙˆØ¯Ø² Ù‚Ø¨Ù„ Ø§Ù„Ø¨Ù†Ø§Ø¡
      - name: Clean Flutter and Pods
        script: |
          echo "ğŸ§¹ Cleaning Flutter & iOS Pods"
          cd ios
          rm -rf Pods Podfile.lock
          pod cache clean --all
          pod install
          cd ..
          flutter clean
          flutter pub get

      # ğŸ—ï¸ 2. Ø¨Ù†Ø§Ø¡ Ù†Ø³Ø®Ø© iOS Ù„Ù„Ø¥ØµØ¯Ø§Ø±
      - name: Build iOS Release
        script: |
          echo "ğŸš€ Building iOS Release"
          flutter build ipa --release --no-tree-shake-icons

      # ğŸ§½ 3. Ø¥ØµÙ„Ø§Ø­ Ù…Ø´ÙƒÙ„Ø© Razorpay Ø¯Ø§Ø®Ù„ Ø§Ù„Ù€ IPA
      - name: Fix Razorpay Nested Frameworks
        script: |
          echo "ğŸ§½ Removing nested frameworks from Razorpay.framework"
          find "$CM_BUILD_DIR/build/ios/iphoneos/Runner.app/Frameworks/Razorpay.framework" -type d -name "Frameworks" -exec rm -rf {} +
          echo "âœ… Razorpay.framework cleaned"

      # ğŸ“¤ 4. Ø±ÙØ¹ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¥Ù„Ù‰ App Store Connect
      - name: Publish to App Store Connect
        script: |
          echo "ğŸ“¤ Uploading to App Store Connect"
          app-store-connect publish \
            --path "$CM_BUILD_DIR/build/ios/ipa/Beytei.ipa" \
            --key-id "$APP_STORE_CONNECT_KEY_IDENTIFIER" \
            --issuer-id "$APP_STORE_CONNECT_ISSUER_ID" \
            --private-key "$APP_STORE_CONNECT_PRIVATE_KEY"

    artifacts:
      - build/ios/ipa/*.ipa

    publishing:
      app_store_connect:
        auth: integration
